// -*- Mode: Text; tab-width: 4; -*-

Table of Contents
-----------------

  * History
  * Checking 5L Out of CVS
  * Building Win32 5L
  * Building Macintosh 5L
  * What Lives Where
  * Important Classes & Modules
  * Testing Your Changes
  * Coding Conventions
  * Checking in Your Changes to 5L
  * Updating the Version Number
  * Ancient Versions

History
-------

  5L has its roots in a 16-bit DOS laserdisc application, and earlier
  multimedia-program-specific runtimes before that.  The current
  code base contains fragments dating back to at least 1993 and perhaps
  earlier.  5L has been worked on by many programmers over the years.
  One of the most prolific programmers in the late 90s and early 2000 was
  Chuck Officer.

Checking 5L Out of CVS
----------------------

  CVS server: imlcvs.dartmouth.edu
  CVS root:   /usr/local/cvsroot

  Check out the modules "5L", "5Ltest_wx".  These correspond to the
  full paths "iml/FiveL/Release", "iml/iml_programs/5Ltest_wx" (you'll
  need to know these to use CVSweb).  Make sure your CVS client uses
  the native end-of-line convetion; this can be a problem under MacOS
  X and some versions of Cygwin/W2K.  Also make sure that CVS clients
  don't check out files out ready-only; this will tend to break the
  engine.

  In the instructions that follow, we'll assume your copy of the 5L source
  tree is in $5L_DIR and your copy of 5Ltest_wx is in $5LTEST_DIR.

Building Win32 5L
-----------------

  Using the System control panel, set the environment variable WXWIN to
  $5L_DIR/libs/wxWidgets.

  Install Visual C++.NET off of the MSDN subscription, after making sure we
  have enough licenses.  Make sure you have everything related to C++
  development or media libraries (including ActiveX).  Also, you probably
  want to download the latest Service Pack.

  Next, download and install the QuickTime 6 SDK.  This can be found at
  developer.apple.com (under Tools > QuickTime > QuickTime 6 SDK).  Unzip
  it in C:\sdk (or anywhere else you like, but then you'll have to adapt the
  instructions below). Make sure QuickTime is installed as well. 

  Open up $5L_DIR\FiveL.sln. Select Tools > Options > Projects > VC++
  Directories, and add the follow directories to the following
  categories:

    Include files:
	  C:\sdk\QT6 SDK (Win)\Interfaces & Libraries\QTDevWin\CIncludes
	  C:\sdk\QT6 SDK (Win)\Interfaces & Libraries\QTDevWin\ComponentIncludes
    Libraries:
	  C:\sdk\QT6 SDK (Win)\Interfaces & Libraries\QTDevWin\Libraries
    Executable files:
	  C:\sdk\QT6 SDK (Win)\Interfaces & Libraries\QTDevWin\Tools

  To build the crash reporter, you'll need to download the Windows Template
  Library from msdn.microsoft.com and set up an include path for its
  directories (see above).

  To debug crash reports immediately, you can add a "Debug" button to
  the CrashReporter by setting the following registry key to a DWORD
  value of "1":

    HKEY_CURRENT_USER\Software\Carruth\CrashRpt\EnableDebug

  Click on "Solution Explorer", right-click on "wx5L", and
  select "Properties" > "Configuration: Debug" > "Debugging"  >
  "Action".  Set "Working Directory" to $5LTEST_DIR (the actual path,
  not the variable name!).  Select "Configuration: Release" and
  set "Working Directory" to the same value.  Now you'll automatically
  run 5Ltest when you ask Visual Studio to launch your program.

  Using a similar process, set the working directories for both versions
  of "CommonTest" to $5L_DIR/Common.  The test suites won't run without
  this step.

  You may also need to look at $5L_DIR/libs/quake2/README-WX.txt. It
  will explain how to set up MSVC with the assembler support to build
  Quake.

  Make sure "Debug" is selected in the "Solution Configurations" popup
  on your toolbar. In the "Solution Explorer", right click on "wx5L"
  and select "Set as StartUp Project". You should now be able to build
  and run 5L by clicking on the "Start" icon (it looks like a play
  button or right facing triangle). If you want to build a component
  without running it, you can select "Build <component>" from the
  build menu, or add the build button to your toolbar by right
  clicking on the toolbar and selecting "Build". 

  To build the release version, select "Release" from the "Solution
  Configurations" popup on your toolbar and follow the same steps as
  above.

  To run the test suites, right click on "CommonTest" and select "Set
  as StartUp Project". Make sure the appropriate configuration is
  selected, debug or release. You'll need to run each of them before
  each check in.

Building Macintosh 5L
---------------------

  Mac5L is not currently supported.  Feel free to do a port.

Source Documentation
--------------------

Tamale is documented using doxygen, an excellent, open source documentation
generator for C++.  You can get beautiful documentation for the entire
codebase--with diagrams--by installing and running doxygen.  See
doc/README.txt for details.

You can also configure doxygen to generate annotated, cross-referenced
source code and call graphs.

What Lives Where
----------------

  libs/               - 3rd-party libraries
  libs/crypto/        - Miscellaneous 3rd-party crypto code
  libs/freetype2/     - 3rd-party font engine
  libs/plt/           - MzScheme interpreter, etc.
  libs/wxWidgets/     - Portable GUI library

  Common/             - Shared, portable code
  Common/Runtime/5L/  - Scheme language runtime support
  Common/Runtime/*/   - Other MzScheme-derived runtime goodies
  Common/Scripts/     - Test scripts
  Common/Fonts/       - Unix-style fonts for FreeType 2
  Common/fonttools/   - Font-related programs (some are Linux-only)

  Win32/              - Win32 engine
  Win32/Bin/          - Win32 binaries
  Win32/VC/           - Win32 Visual C++ projects and workspaces
  Win32/DibLib/       - Microsoft code for manipulating bitmaps
  Win32/FiveL/        - Win32 5L source
  Win32/CryptTool/    - A tool for encrypting scripts

  Mac/                - Mac OS 9 and Carbon engine
  Mac/Bin/            - Mac binaries
  Mac/Source/         - Mac 5L core engine
  Mac/Player/         - Mac 5L graphics layer 
  Mac/Resources/      - MacOS and PowerPlant resources
  Mac/Utility/        - Third-party utility routines

  wx/                 - Preliminary (portable?) front-end based on wxWidgets
  wx/MSVC             - MSVC project files
  wx/src              - Source code to new front end

Important Classes & Modules
---------------------------

  * TCommon.h, TPlatform.h
    - Lots of defines and portability stuff.

  * TString, TBTree, TBNode, TArray
    - Basic data structures.  Try to use the STL in new code instead.

  * TPoint, TRect
    - Fairly featureful points and rectangles.

  * FileSystem, GraphicsTools
    - New portable libraries for pathnames and graphics.  Use these.

  * Typography, TStyleSheet
    - Portable, anti-aliased text service based on FreeType.  Not as
      nice as pango, but it doesn't require nearly as much support code.

  * TException
    - Parent class of most 5L exceptions.
    - Use exceptions for error-handling in new code.
    - Not all old code is exception-safe, so be careful.
  
  * ImlUnit
    - A very simple testing library inspired by the various XP tools.

  * TLogger
    - The logging and error-reporting subsystem.
    - Use this if you need to abort the program, or show errors to the user.

  * TInterpreter
    - Abstract interface to interchangeable interpreters.
    - Subclass this to add a new language.

  * TInterpreterManager
    - Manages interpreters and implements script reloading.
    - Subclass this to add a new language.

  * TPrimitives, TCommonPrimitives, TMacPrimitives, TWinPrimitives, etc.
    - Implementations of the actual 5L commands.

  * TIndex, TParser, TStream, C?Card, C?Macro,
  * T5LPrimitives, T{Win,Mac}5LInterpreter
    - The nasty old 5L interpreter.

  * {C,L}Resource and subclasses
    - A simple memory-management architecture for loading and purging
      various resources, including graphics, cursors and OS fonts.

  * TStartup
    - Initializes the Common library.

  * CryptStream
    - Encrypted I/O.
    - Lots of assertion failures & problem code.
    - This may be deprecated in the foreseeable future.

  * Audio, Video, LQuickTime
    - Windows audio/video playback system.

  * Graphics
    - Old windows drawing routines.

  * Header, LFont, CHeader, CText
    - Older, non-portable font routines.

  * {C,L}Files, LFileBundle
    - 5L file I/O code.
    - LFileBundle has assertion failures and other problems.

  * {C,L}TouchZone
    - Buttons and touchzones.  Pretty ugly.

  * CConfig, CModule, Config
    - Managing multiple scripts, media sets.
    - Finding audio/video resources.

  * CPlayerView (Mac), LView (Win)
    - The actual 5L "drawing area", as it appears on screen.

  * CMac5LApp (Mac), FiveL.cpp (Win)
    - The 5L startup code.

  We are slowly merging the Macintosh and Windows code into a portable
  engine.  This process began in early 2002, and has produced more than
  20,000 lines of merged code as of this summer.

Coding Conventions
------------------

  The 5L source includes a wide variety of coding styles.  In general, you
  should either (1) immitate the locally-prevailing style when making small
  changes to existing code or (2) use the officially approved coding style
  (below) when making big changes or writing new code.  Please DO NOT use
  non-standard styles in new code; the tree is inconsistent enough as is.

  For a small example class (showing reasonably good style), see
  Common/TException.{h,cpp}.

  All files should begin with the following comment, which should make
  Emacs Do The Right Thing<tm> on most systems:

    // -*- Mode: C++; tab-width: 4; c-basic-offset: 4; -*-

  Tabs are four spaces wide, blocks are indented four spaces, and braces
  always appear on their own line.  The keywords "public:", "private:" and
  "protected:" should be flush with the "class" keyword, not indented an
  extra level.  Continued expressions should be indented Emacs-style:

  int long_name = munge(really_long_name,
                        another_really_long_name);

  Global variables are named with a "g" prefix, static variables with an
  "s" prefix, and local variables with an "m" prefix (although a few
  classes use different conventions, and it's best to follow conventions
  within a class--I've seen both "m_" and "its" prefixes).  Input
  parameters have a "in" prefix, output parameters have an "out" prefix,
  and input/ouput parameters have an "io" prefix.

  Publically-visible names use lowercase interior capitals and no
  underscores (i.e. studlyCaps).  Functions names should have initial
  capitals; variable names shouldn't.  Local variables may optionally use
  all lowercase names with internal underscores.  Preprocessor macros
  follow the usual convention.  Examples:

    MyClass
    GlobalFunction
    gGlobalVariable
    mMemberVariable
    sStaticVariable
    inInputParameter
    outOutputParameter
    ioInputOutputParameter
    local_variable
    PREPROCESSOR_MACRO

  Class and method comments should obey this rather odd format:

    //////////
    // Munge the input variables, as described on page 12 of the
	// Really Nifty Multimedia Programming Book.
	//
	// [in] inItemCount - The number of items to munge.
	// [in/out] ioItems - The items to munge.
	// [out] outMungedItemCount - The number of items munged.
    // [out] return - The number of munging passes required.
	// 
    int MungeItems(int inItemCount, Item *ioItems, int *outMungedItemCount);

  There was once some freeware, non-distributable tool which could turn
  these into nice web pages.  Somebody should probably write an open source
  version. :-)

  Code is 79 columns wide or less!

Testing Your Changes
--------------------

  We have two test suites: "TestAll", which is a fully-automated, low-level
  test suite (as advocated by the eXtreme Programming folks), and "5Ltest",
  an interactive, high-level test script written in 5L.

  * Updating "TestAll"  

  Let's say you've added a new data structure, FooList, to the Common
  directory.  You should create a file named "FooListTests.cpp", and fill
  it full of tests.  Take a look at TStringTests.cpp for a good example.
  There's an art to writing good tests: You get all the common behaviors
  and corner cases, but you shouldn't write zillions of tests which prove
  nothing.

  For bonus points, write your tests *before* adding new features.

  Hook your test cases into TestAll.cpp.  You can figure out how to
  do this by looking at the source.

  * Updating "5Ltest"

  Unfortunately, "TestAll" still can't test lots of things: primitives,
  graphics, platform-specific code, etc.  In these cases, add one or
  more new cards to $5LTEST_DIR/Scripts/5Ltest.scr and hook them into the
  main menu.

  Be sure to include a good description of how to use your test card!
  Anybody at IML should be able to read instructions on the screen and
  tell whether or not the test card is working.  (We have lots of older
  test cards without such helpful documentation; these are real problems
  when testing.

Checking in Your Changes to 5L
------------------------------

  1) Decide whether you want to update the 5L version number.  If so, see
     the instructions below.

  2) Build your test suite (in all configurations).  Run each version, and
     make sure it prints "OK".  Don't skip this step; it catches about half
     of the impossible-to-find-and-really-vicious bugs.

  3) Build 5L (in all configurations).  Run each version, and look at all
     the relevant 5Ltest cards.  Again, don't skip this step; it catches
     about half the *dumb* bugs.

  4) If you're using Windows, MAKE SURE YOU SAVE YOUR WORKSPACE, or else
     CVS won't know about any changes.

  5) Make sure you've issued all the necessary "cvs add" and "cvs remove"
     commands.  Read your CVS diffs.

  6) Update $5L_DIR/Release-Notes.txt.  If you're not creating a new
     version number, just use "CVS" as a placeholder instead.

  7) Check in your changes.  If you haven't assigned a new version number,
     try to avoid checking in the contents of Mac/Bin or Win32/Bin.  If you
     *have* assigned a version number, you MUST check in the contents of
     those directories.

     Write a good CVS comment.  It should be useful, informative and
     reasonably detailed.  It should generally use complete sentences and
     good grammar.  You're writing for posterity.

  8) If you've assigned a version number to your changes, tag the entire
     $5L_DIR tree AFTER checking it in.  The tag for 5L 3.3.9 would be
     "FiveL_3_3_9".  DO NOT FORGET THIS STEP OR PEOPLE WILL GET VERY GRUMPY
     AND SAY BAD THINGS ABOUT YOU MANY YEARS FROM NOW.

  9) Check in 5Ltest, too, if you've made any changes.

Updating the Version Number
---------------------------

  5L uses Linux-style version numbers.  That means versions have the form
  "X.Y.Z", where X is the "major version", Y is the "minor version" and "Z"
  is the "revision".  (Actually, there will sometimes be an extra number
  after the revision, if somebody is working on a CVS branch).  X, Y, and Z
  count up from 0: 0, 1, 2, ..., 9, 10, 11, etc.

  1) Update Common/TVersion.h.

  2) Windows: Click on "ResourceView", "FiveL resources", "Version",
     "VS_VERSION_INFO", and update 3 occurances of the version number.  The
     other 2 will update automatically.  While there, check the copyright
     date; it should be of the form "1993-YYYY", where YYYY is the current
     year.  The lawyers like this to be correct.

  3) Macintosh: Open up Mac5L-Version.r in ResEdit, and update the two 'vers'
     resources.  If you have more than 3 version components (e.g.,
     "3.2.1.3"), then you'll only be able to enter the first 3, and no
     version component may be greater than 9 (you can, of course, enter the
     full version in the free-form text fields).  Again, check the
     copyright.

Ancient Versions
----------------

  We shipped Genetics in Clinical Practice on top of an older engine (early
  2002) which has substantially more primitive build and testing procedures.
  Also, this engine exists in entirely separate Windows and Macintosh
  versions, with no shared code.

  You can find this engine in CVS as FiveL_3_1_1_Stabilization and
  Mac5L_202_Stable.  Release notes are in Win32/ReleaseNotes.txt and
  Mac/ReleaseNotes.

libxml2 Hacks
-------------

I made a static version of libxml2 for Tamale by cloning the "Win32 Debug"
and "Win32 Release" targets to "Win32 Debug DLL" and "Win32 Release DLL"
respectively, then opening up the DSP file in Emacs.  After the TARGTYPE
line:

  # TARGTYPE "Win32 (x86) Dynamic-Link Library" 0x0102

...I inserted a second target type:

  # TARGTYPE "Win32 (x86) Static Library" 0x0104

Then I edited the comments further down to read as follows:

  !MESSAGE "libxml2 - Win32 Debug" (based on "Win32 (x86) Static Library")
  !MESSAGE "libxml2 - Win32 Release" (based on "Win32 (x86) Static Library")

Then I re-opened the DSP file in Visual Studio and made the following
changes to each of the non-DLL targets:

  * Set the /nologo flag.
  * Set appropriate build and output directories.
  * Replaced the _USRDLL proprocessor define with _LIB.
  * Set a runtime library which matched my project.


Unix Command Line Magic for Doing CVS Merges
----------------------------------------

Handy CVS hacking notes.  WARNING: DON'T RUN ANY OF THESE COMMANDS UNTIL
YOU UNDERSTAND *EXACTLY* WHAT THEY DO.  IN DETAIL.  AND WHY THEY DO IT.

Remove all CVS directories from a tree:

  find . \( -name CVS -type d \) -exec rm -r {} \; -prune

Replace all files containing conflicts with fresh copies from a current
directory: 

  cvs -n update > conflicts.txt
  for F in `cat conflicts.txt | grep 'C' | sed 's/^. //'`; do mv ../wxWidgets/$
F $F; done

In the following snippet, wxWidgets-HEAD is an exported version of HEAD,
and wxWidgets is the latest version of wxWidgets, minus CVS directories.
We're computing a list of "interesting" differences (hence -x and -I).
We're trying to revert HEAD to match the vendor branch.

$ diff -ur --unidirectional-new-file -x .cvsignore -I "\\\$\\(Revision\\|Id\\|H
eader\\|Date\\):" -I "^ * " wxWidgets-HEAD/ wxWidgets > wx-revert-to-vendor.dif
f

Remove any files which should be removed from HEAD:

$ grep "^Only in" /cygdrive/c/src/wx-revert-to-vendor.diff | sed "s/^Only in wx
Windows-HEAD\\/\\(: \\)*//" | sed "s/: /\\//" | xargs cvs remove -f -R

Try to overwrite binary files which differed from their vendor versions.
This didn't actually seem to do anything--the files all appeared to be
unchanged, and CVS claimed it couldn't create some of them.  I'm not going
to worry about it.

$ for F in `grep "^Binary files" /cygdrive/c/src/wx-revert-to-vendor.diff | sed
 's|^[^/]*/||' | sed 's| and .*||'`; do mv /cygdrive/c/src/wxWidgets/$F $F; don
e
